<mat-card (click)="$event.stopPropagation()"
          (auxclick)="$event.stopPropagation()"
          (contextmenu)="showContextMenu($event)"
          (mouseup)="$event.stopPropagation()"
          [style.color]="taskList.foregroundColor"
          [style.background]="taskList.backgroundColorGradient
            ? 'linear-gradient(to bottom, ' + taskList.backgroundColor + ', ' + taskList.backgroundColorGradient
            : taskList.backgroundColor">
  <mat-card-title class="flex-container">
    {{taskList.header ?? 'Tasks'}}
  </mat-card-title>
  <mat-card-content cdkDropList (cdkDropListDropped)="dropItem($event)" [cdkDropListData]="taskList.items">
    <ng-container *ngFor="let item of taskList.items">
      <ng-container *ngIf="item !== itemToEdit">
        <span class="flex-container" style="margin: 0; gap: 20px;" cdkDrag>
          <span>
            <ng-container *ngIf="item.isSubTask">
              <button mat-icon-button class="item-button" style="opacity: 0.1; margin-left: -6px"
                      (click)="item.isSubTask = false"
                      matTooltip="Move to left" matTooltipPosition="left">
                <mat-icon>remove</mat-icon>
              </button>
            </ng-container>
            <ng-container *ngIf="!item.isSubTask">
              <button mat-icon-button class="item-button" style="opacity: 0.1; margin-left: -34px"
                      (click)="item.isSubTask = true"
                      matTooltip="Move to right" matTooltipPosition="left">
                <mat-icon>arrow_right</mat-icon>
              </button>
            </ng-container>
            <mat-checkbox [(ngModel)]="item.checked" (change)="dataService.cacheData()">
              {{item.value}}
            </mat-checkbox>
            <button mat-icon-button class="item-button" style="opacity: 0.1"
                    (click)="addItemAfter(item)"
                    matTooltip="Add task" matTooltipPosition="right">
              <mat-icon>add</mat-icon>
            </button>
          </span>
          <span>
            <button mat-icon-button class="item-button"
                    (click)="startEditItem(item)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button class="item-button" style="margin-right: -8px"
                    (click)="deleteItem(item)">
              <mat-icon>delete</mat-icon>
            </button>
          </span>
        </span>
      </ng-container>
      <ng-container *ngIf="item === itemToEdit">
        <span class="flex-container" style="margin: 0">
          <span style="display: contents">
            <ng-container *ngIf="item.isSubTask">
              <button mat-icon-button class="item-button" style="opacity: 0.1; margin-left: -6px"
                      (click)="item.isSubTask = false"
                      matTooltip="Move to left" matTooltipPosition="left">
                <mat-icon>remove</mat-icon>
              </button>
            </ng-container>
            <ng-container *ngIf="!item.isSubTask">
              <button mat-icon-button class="item-button" style="opacity: 0.1; margin-left: -34px"
                      (click)="item.isSubTask = true"
                      matTooltip="Move to right" matTooltipPosition="left">
                <mat-icon>arrow_right</mat-icon>
              </button>
            </ng-container>
            <mat-checkbox [checked]="item.checked" (change)="markAsChecked(item)">
            </mat-checkbox>
            <input [(ngModel)]="item.value" (mousedown)="$event.stopPropagation()" autofocus>
          </span>
          <button mat-icon-button class="item-button animated" style="margin-right: -8px"
                  (click)="endEditItem(item)">
            <mat-icon>check</mat-icon>
          </button>
        </span>
      </ng-container>
    </ng-container>
  </mat-card-content>
  <mat-card-actions align="end">
    <button mat-icon-button (click)="addItem()">
      <mat-icon>add</mat-icon>
    </button>
    <button mat-icon-button (click)="select()">
      <mat-icon>{{taskList.selected ? 'close' : 'check'}}</mat-icon>
    </button>
    <button mat-icon-button (click)="edit()">
      <mat-icon>edit</mat-icon>
    </button>
    <button mat-icon-button (click)="delete(); $event.stopPropagation()">
      <mat-icon>delete</mat-icon>
    </button>
    <button mat-icon-button (click)="showContextMenu($event)">
      <mat-icon>more_vert</mat-icon>
    </button>
  </mat-card-actions>
  <mat-card-footer [style.margin-bottom.px]="-32"></mat-card-footer>
</mat-card>

<div style="visibility: hidden; position: fixed"
     [style.left.px]="rightClickPosX"
     [style.top.px]="rightClickPosY"
     [matMenuTriggerFor]="contextMenu">
</div>
<mat-menu #contextMenu="matMenu">
  <div [style.color]="taskList.foregroundColor"
       [style.background]="taskList.backgroundColorGradient
            ? 'linear-gradient(to bottom, ' + taskList.backgroundColor + ', ' + taskList.backgroundColorGradient
            : taskList.backgroundColor">
    <button mat-menu-item (click)="dataService.bringToFront(this.taskList)">
      <mat-icon>flip_to_front</mat-icon>
      Bring to front
    </button>
    <button mat-menu-item (click)="dataService.bringForward(this.taskList)">
      <mat-icon>add_circle_outline</mat-icon>
      Bring forward
    </button>
    <button mat-menu-item (click)="dataService.sendBackward(this.taskList)">
      <mat-icon>remove_circle_outline</mat-icon>
      Send backward
    </button>
    <button mat-menu-item (click)="dataService.flipToBack(this.taskList)">
      <mat-icon>flip_to_back</mat-icon>
      Send to back
    </button>
    <ng-container *ngIf="dataService.tabs.length > 1">
      <button mat-menu-item [matMenuTriggerFor]="tabs">
        <mat-icon>drive_file_move</mat-icon>
        Move
      </button>
    </ng-container>
    <button mat-menu-item (click)="addItem()">
      <mat-icon>add</mat-icon>
      Add item
    </button>
    <button mat-menu-item (click)="select()">
      <mat-icon>{{taskList.selected ? 'close' : 'check'}}</mat-icon>
      {{taskList.selected ? 'Remove selection' : 'Select'}}
    </button>
    <button mat-menu-item (click)="edit()">
      <mat-icon>edit</mat-icon>
      Edit
    </button>
    <button mat-menu-item (click)="delete()">
      <mat-icon>delete</mat-icon>
      Delete
    </button>
  </div>
</mat-menu>

<mat-menu #tabs="matMenu">
  <div [style.color]="taskList.foregroundColor"
       [style.background]="taskList.backgroundColorGradient
            ? 'linear-gradient(to bottom, ' + taskList.backgroundColor + ', ' + taskList.backgroundColorGradient
            : taskList.backgroundColor">
    <ng-container *ngFor="let tab of dataService.tabs">
      <button mat-menu-item (click)="moveToTab(tab.index)" *ngIf="dataService.currentTabIndex != tab.index">
        {{tab.label ? tab.label : '#Board ' + (tab.index + 1)}}
      </button>
    </ng-container>
  </div>
</mat-menu>
